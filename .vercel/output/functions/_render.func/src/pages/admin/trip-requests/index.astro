---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

// Fetch all trip requests
const { data: tripRequests, error } = await supabase
    .from("trip_requests")
    .select("*")
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching trip requests:", error);
}

const statusColors = {
    pending: "bg-yellow-100 text-yellow-800",
    reviewed: "bg-blue-100 text-blue-800",
    contacted: "bg-purple-100 text-purple-800",
    converted: "bg-green-100 text-green-800",
    rejected: "bg-red-100 text-red-800",
};
---

<AdminLayout title="Trip Requests">
    <div class="mb-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1
                    class="text-4xl font-['Playfair_Display'] text-[#006064] mb-2"
                >
                    Trip Requests
                </h1>
                <p class="text-[#006064]/70">
                    Manage customer inquiries and trip requests
                </p>
            </div>

            <!-- Back to Admin Dashboard -->
            <a
                href="/admin"
                class="inline-flex items-center gap-2 text-[#26A69A] hover:text-[#006064] mb-6 font-medium"
            >
                ← Back to Admin Dashboard
            </a>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                <div
                    class="bg-white rounded-xl p-4 shadow-md cursor-pointer hover:shadow-lg transition-all filter-card ring-2 ring-transparent"
                    data-status="all"
                >
                    <p class="text-sm text-[#006064]/70">Total Requests</p>
                    <p class="text-2xl font-bold text-[#006064]">
                        {tripRequests?.length || 0}
                    </p>
                </div>
                <div
                    class="bg-yellow-50 rounded-xl p-4 shadow-md cursor-pointer hover:shadow-lg transition-all filter-card ring-2 ring-transparent"
                    data-status="pending"
                >
                    <p class="text-sm text-yellow-800">Pending</p>
                    <p class="text-2xl font-bold text-yellow-800">
                        {
                            tripRequests?.filter((r) => r.status === "pending")
                                .length || 0
                        }
                    </p>
                </div>
                <div
                    class="bg-blue-50 rounded-xl p-4 shadow-md cursor-pointer hover:shadow-lg transition-all filter-card ring-2 ring-transparent"
                    data-status="reviewed"
                >
                    <p class="text-sm text-blue-800">Reviewed</p>
                    <p class="text-2xl font-bold text-blue-800">
                        {
                            tripRequests?.filter((r) => r.status === "reviewed")
                                .length || 0
                        }
                    </p>
                </div>
                <div
                    class="bg-purple-50 rounded-xl p-4 shadow-md cursor-pointer hover:shadow-lg transition-all filter-card ring-2 ring-transparent"
                    data-status="contacted"
                >
                    <p class="text-sm text-purple-800">Contacted</p>
                    <p class="text-2xl font-bold text-purple-800">
                        {
                            tripRequests?.filter(
                                (r) => r.status === "contacted",
                            ).length || 0
                        }
                    </p>
                </div>
                <div
                    class="bg-green-50 rounded-xl p-4 shadow-md cursor-pointer hover:shadow-lg transition-all filter-card ring-2 ring-transparent"
                    data-status="converted"
                >
                    <p class="text-sm text-green-800">Converted</p>
                    <p class="text-2xl font-bold text-green-800">
                        {
                            tripRequests?.filter(
                                (r) => r.status === "converted",
                            ).length || 0
                        }
                    </p>
                </div>
            </div>

            <!-- Trip Requests Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                {
                    tripRequests && tripRequests.length > 0 ? (
                        <div class="overflow-x-auto">
                            <table class="w-full" id="requestsTable">
                                <thead class="bg-[#26A69A] text-white">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Date
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Contact
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Destination
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Dates
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Travelers
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Status
                                        </th>
                                        <th class="px-6 py-4 text-left text-sm font-medium">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {tripRequests.map((request) => (
                                        <tr
                                            class="hover:bg-[#E0F7FA]/30 transition-colors request-row"
                                            data-status={request.status}
                                        >
                                            <td class="px-6 py-4 text-sm text-[#006064]">
                                                {new Date(
                                                    request.created_at,
                                                ).toLocaleDateString()}
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm">
                                                    <p class="font-medium text-[#006064]">
                                                        {request.contact_name}
                                                    </p>
                                                    <p class="text-[#006064]/70">
                                                        {request.contact_email}
                                                    </p>
                                                    {request.contact_phone && (
                                                        <p class="text-[#006064]/70">
                                                            {
                                                                request.contact_phone
                                                            }
                                                        </p>
                                                    )}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-[#006064] font-medium">
                                                {request.destination}
                                            </td>
                                            <td class="px-6 py-4 text-sm text-[#006064]">
                                                <div>
                                                    <p>
                                                        {new Date(
                                                            request.start_date,
                                                        ).toLocaleDateString()}
                                                    </p>
                                                    <p class="text-[#006064]/70">
                                                        to
                                                    </p>
                                                    <p>
                                                        {new Date(
                                                            request.end_date,
                                                        ).toLocaleDateString()}
                                                    </p>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-[#006064]">
                                                {request.adults} Adult
                                                {request.adults > 1 ? "s" : ""}
                                                {request.children > 0 && (
                                                    <span>
                                                        , {request.children}{" "}
                                                        Child
                                                        {request.children > 1
                                                            ? "ren"
                                                            : ""}
                                                    </span>
                                                )}
                                            </td>
                                            <td class="px-6 py-4">
                                                <span
                                                    class={`px-3 py-1 rounded-full text-xs font-medium ${statusColors[request.status as keyof typeof statusColors]}`}
                                                >
                                                    {request.status
                                                        .charAt(0)
                                                        .toUpperCase() +
                                                        request.status.slice(1)}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <a
                                                    href={`/admin/trip-requests/${request.id}`}
                                                    class="text-[#26A69A] hover:text-[#1F8B7F] font-medium text-sm"
                                                >
                                                    View Details →
                                                </a>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div class="text-center py-12">
                            <p class="text-[#006064]/50 text-lg">
                                No trip requests yet
                            </p>
                            <p class="text-[#006064]/40 text-sm mt-2">
                                Requests will appear here when customers submit
                                trip inquiries
                            </p>
                        </div>
                    )
                }
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const filterCards = document.querySelectorAll(".filter-card");
            const rows = document.querySelectorAll(".request-row");
            let activeStatus = "all";

            // Initialize: highlight "Total Requests"
            const allCard = document.querySelector('[data-status="all"]');
            if (allCard) {
                allCard.classList.add("ring-[#26A69A]");
            }

            filterCards.forEach((card) => {
                card.addEventListener("click", () => {
                    const status = card.getAttribute("data-status");

                    // Toggle logic: if clicking active status (and not 'all'), revert to 'all'
                    if (activeStatus === status && status !== "all") {
                        activeStatus = "all";
                    } else {
                        activeStatus = status;
                    }

                    // Update UI: Highlight active card
                    filterCards.forEach((c) => {
                        c.classList.remove("ring-[#26A69A]");
                        if (c.getAttribute("data-status") === activeStatus) {
                            c.classList.add("ring-[#26A69A]");
                        }
                    });

                    // Filter Rows
                    rows.forEach((row) => {
                        const rowStatus = row.getAttribute("data-status");
                        if (
                            activeStatus === "all" ||
                            rowStatus === activeStatus
                        ) {
                            row.classList.remove("hidden");
                        } else {
                            row.classList.add("hidden");
                        }
                    });
                });
            });
        });
    </script>
</AdminLayout>
