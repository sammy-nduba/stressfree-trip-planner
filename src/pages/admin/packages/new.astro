---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { createServerSupabaseClient } from "../../../lib/supabase";

// Create server-side Supabase client with authenticated session
const supabase = createServerSupabaseClient(Astro.cookies);

// Handle form submission
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const title = formData.get("title");
        const description = formData.get("description");
        const price = formData.get("price");
        const duration = formData.get("duration");
        const destination_id = formData.get("destination_id");
        const imageFile = formData.get("image") as File;

        let image_url = "";

        if (imageFile && imageFile.size > 0) {
            const fileExt = imageFile.name.split(".").pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
            const { error: uploadError } = await supabase.storage
                .from("packages")
                .upload(fileName, imageFile);

            if (uploadError) throw uploadError;

            const {
                data: { publicUrl },
            } = supabase.storage.from("packages").getPublicUrl(fileName);

            image_url = publicUrl;
        } else {
            // Fallback if they somehow bypassed the required check or if we want to allow URL input as backup (not implemented here)
            throw new Error("Image is required");
        }

        const inclusions = formData
            .get("included")
            ?.toString()
            .split("\n")
            .filter((i) => i.trim());
        const exclusions = formData
            .get("not_included")
            ?.toString()
            .split("\n")
            .filter((i) => i.trim());

        const { error } = await supabase.from("packages").insert({
            name: title,
            description,
            price: parseFloat(price?.toString() || "0"),
            duration: parseInt(duration?.toString() || "0"),
            destination_id: parseInt(destination_id?.toString() || "0"),
            image: image_url,
            inclusions,
            exclusions,
        });

        if (error) throw error;

        return Astro.redirect("/admin/packages");
    } catch (error) {
        console.error("Error creating package:", error);
    }
}

// Fetch destinations for the dropdown
const { data: destinations } = await supabase
    .from("destinations")
    .select("id, name, country_id")
    .order("name");

// Fetch countries for the dropdown
const { data: countries } = await supabase
    .from("countries")
    .select("id, name")
    .order("name");
---

<AdminLayout title="Create Package">
    <div class="max-w-3xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Create New Package</h1>
            <a
                href="/admin/packages"
                class="text-gray-600 hover:text-gray-800 font-medium"
            >
                Cancel
            </a>
        </div>

        <form
            method="POST"
            enctype="multipart/form-data"
            class="bg-white rounded-xl shadow-lg p-8 space-y-6"
        >
            <!-- Basic Info -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label
                        for="title"
                        class="block text-sm font-medium text-gray-700"
                        >Package Title</label
                    >
                    <input
                        type="text"
                        id="title"
                        name="title"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="e.g., Magical Maldives"
                    />
                </div>

                <div class="space-y-2">
                    <label
                        for="country_id"
                        class="block text-sm font-medium text-gray-700"
                        >Country</label
                    >
                    <select
                        id="country_id"
                        name="country_id"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                    >
                        <option value="">Select a country...</option>
                        {
                            countries?.map((country) => (
                                <option value={country.id}>
                                    {country.name}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <div class="space-y-2">
                    <label
                        for="destination_id"
                        class="block text-sm font-medium text-gray-700"
                        >Destination</label
                    >
                    <select
                        id="destination_id"
                        name="destination_id"
                        required
                        disabled
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                    >
                        <option value="">Select a country first...</option>
                        {
                            destinations?.map((dest) => (
                                <option
                                    value={dest.id}
                                    data-country-id={dest.country_id}
                                    class="hidden destination-option"
                                >
                                    {dest.name}
                                </option>
                            ))
                        }
                    </select>
                </div>
            </div>

            <div class="space-y-2">
                <label
                    for="description"
                    class="block text-sm font-medium text-gray-700"
                    >Description</label
                >
                <textarea
                    id="description"
                    name="description"
                    rows="4"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                    placeholder="Detailed description of the package..."
                ></textarea>
            </div>

            <!-- Details -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label
                        for="price"
                        class="block text-sm font-medium text-gray-700"
                        >Price ($)</label
                    >
                    <input
                        type="number"
                        id="price"
                        name="price"
                        min="0"
                        step="0.01"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                    />
                </div>

                <div class="space-y-2">
                    <label
                        for="duration"
                        class="block text-sm font-medium text-gray-700"
                        >Duration (days)</label
                    >
                    <input
                        type="number"
                        id="duration"
                        name="duration"
                        min="1"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="e.g., 5"
                    />
                </div>
            </div>

            <div class="space-y-2">
                <label
                    for="image"
                    class="block text-sm font-medium text-gray-700"
                    >Package Image</label
                >
                <input
                    type="file"
                    id="image"
                    name="image"
                    accept="image/*"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                />
                <p class="text-sm text-gray-500">
                    Upload a high-quality image for the package.
                </p>
            </div>

            <!-- Lists -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label
                        for="included"
                        class="block text-sm font-medium text-gray-700"
                        >Included (One per line)</label
                    >
                    <textarea
                        id="included"
                        name="included"
                        rows="6"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="Accommodation
Breakfast
Transfers"
                    ></textarea>
                </div>

                <div class="space-y-2">
                    <label
                        for="not_included"
                        class="block text-sm font-medium text-gray-700"
                        >Not Included (One per line)</label
                    >
                    <textarea
                        id="not_included"
                        name="not_included"
                        rows="6"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="Flights
Visa
Personal Expenses"></textarea>
                </div>
            </div>

            <div class="pt-6 border-t border-gray-200 flex justify-end gap-4">
                <a
                    href="/admin/packages"
                    class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors"
                >
                    Cancel
                </a>
                <button
                    type="submit"
                    class="px-6 py-2 bg-teal text-white rounded-lg hover:bg-teal/90 font-medium transition-colors"
                >
                    Create Package
                </button>
            </div>
        </form>
    </div>
</AdminLayout>

<script>
    const countrySelect = document.getElementById(
        "country_id",
    ) as HTMLSelectElement;
    const destinationSelect = document.getElementById(
        "destination_id",
    ) as HTMLSelectElement;
    const destinationOptions = document.querySelectorAll(".destination-option");

    countrySelect?.addEventListener("change", (e) => {
        const selectedCountryId = (e.target as HTMLSelectElement).value;

        // Reset destination selection
        destinationSelect.value = "";

        if (!selectedCountryId) {
            destinationSelect.disabled = true;
            destinationSelect.innerHTML =
                '<option value="">Select a country first...</option>';
            return;
        }

        destinationSelect.disabled = false;
        destinationSelect.innerHTML =
            '<option value="">Select a destination...</option>';

        // Filter options
        destinationOptions.forEach((option) => {
            const opt = option as HTMLOptionElement;
            if (opt.dataset.countryId === selectedCountryId) {
                const clone = opt.cloneNode(true) as HTMLOptionElement;
                clone.classList.remove("hidden");
                destinationSelect.appendChild(clone);
            }
        });
    });
</script>
