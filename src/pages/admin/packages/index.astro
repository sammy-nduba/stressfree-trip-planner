---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

// Handle package deletion or toggle featured
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const id = formData.get("id");
  const action = formData.get("action");

  if (action === "delete" && id) {
    const { error } = await supabase.from("packages").delete().eq("id", id);
    if (error) {
      console.error("Error deleting package:", error);
    }
  } else if (action === "toggle-featured" && id) {
    const isFeatured = formData.get("featured") === "true";
    const { error } = await supabase
      .from("packages")
      .update({ is_featured: !isFeatured })
      .eq("id", id);
    if (error) {
      console.error("Error toggling featured status:", error);
    }
  }
}

// Fetch all packages from the database
const { data: packages, error } = await supabase
  .from("packages")
  .select(
    `
  *,
  destinations (
    name,
    countries (name)
  )
`,
  )
  .order("created_at", { ascending: false });

if (error) {
  console.error("Error fetching packages:", error);
}
---

<AdminLayout title="Manage Packages">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8"
  >
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Manage Packages</h1>
      <p class="text-gray-500 mt-1">
        Create, edit, and manage your holiday packages.
      </p>
    </div>
    <a
      href="/admin/packages/new"
      class="inline-flex items-center px-6 py-3 bg-teal text-white font-semibold rounded-xl hover:bg-teal/90 transition-all shadow-lg shadow-teal/20"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 mr-2"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
          clip-rule="evenodd"></path>
      </svg>
      Add New Package
    </a>
  </div>

  <div
    class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-50/50">
            <th
              class="p-4 font-semibold text-gray-600 text-sm uppercase tracking-wider"
              >Package Details</th
            >
            <th
              class="p-4 font-semibold text-gray-600 text-sm uppercase tracking-wider"
              >Pricing</th
            >
            <th
              class="p-4 font-semibold text-gray-600 text-sm uppercase tracking-wider"
              >Location</th
            >
            <th
              class="p-4 font-semibold text-gray-600 text-sm uppercase tracking-wider"
              >Featured</th
            >
            <th
              class="p-4 font-semibold text-gray-600 text-sm uppercase tracking-wider text-right"
              >Actions</th
            >
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {
            packages &&
              packages.map((pkg) => (
                <tr class="hover:bg-gray-50/50 transition-colors">
                  <td class="p-4">
                    <div class="flex items-center gap-4">
                      {pkg.image_url ? (
                        <img
                          src={pkg.image_url}
                          alt=""
                          class="w-12 h-12 rounded-lg object-cover"
                        />
                      ) : (
                        <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6 text-gray-400"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                            />
                          </svg>
                        </div>
                      )}
                      <div>
                        <div class="font-bold text-gray-900">{pkg.name}</div>
                        <div class="text-sm text-gray-500">
                          {pkg.duration} Days
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="p-4 text-gray-700">
                    <span class="font-semibold text-teal">
                      ${pkg.price.toLocaleString()}
                    </span>
                  </td>
                  <td class="p-4">
                    <div class="text-gray-800 font-medium">
                      {pkg.custom_destination ||
                        pkg.destinations?.name ||
                        "Custom Location"}
                    </div>
                    <div class="text-xs text-gray-500 uppercase tracking-tighter">
                      {pkg.destinations?.countries?.name || "No Country"}
                    </div>
                  </td>
                  <td class="p-4">
                    <form method="POST">
                      <input type="hidden" name="id" value={pkg.id} />
                      <input
                        type="hidden"
                        name="action"
                        value="toggle-featured"
                      />
                      <input
                        type="hidden"
                        name="featured"
                        value={pkg.is_featured ? "true" : "false"}
                      />
                      <button
                        type="submit"
                        class={`px-3 py-1 rounded-full text-xs font-bold transition-colors ${pkg.is_featured ? "bg-amber-100 text-amber-700 hover:bg-amber-200" : "bg-gray-100 text-gray-500 hover:bg-gray-200"}`}
                      >
                        {pkg.is_featured ? "★ Featured" : "☆ Standard"}
                      </button>
                    </form>
                  </td>
                  <td class="p-4 text-right">
                    <div class="flex justify-end items-center gap-2">
                      <a
                        href={`/admin/packages/${pkg.id}/edit`}
                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                        title="Edit Package"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="h-5 w-5"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.707.707-2.828-2.828.707-.707zM11.36 6.136l-7.464 7.464-1.212 3.636 3.636-1.212 7.464-7.464-2.828-2.828z" />
                        </svg>
                      </a>

                      <form
                        method="POST"
                        class="inline"
                        onsubmit="return confirm('Are you sure you want to delete this package? This action cannot be undone.');"
                      >
                        <input type="hidden" name="id" value={pkg.id} />
                        <input type="hidden" name="action" value="delete" />
                        <button
                          type="submit"
                          class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                          title="Delete Package"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))
          }
        </tbody>
      </table>
      {
        (!packages || packages.length === 0) && (
          <div class="p-12 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 text-gray-400 mb-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
                />
              </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900">No packages found</h3>
            <p class="text-gray-500 mt-1">
              Get started by creating your first holiday package.
            </p>
            <a
              href="/admin/packages/new"
              class="inline-flex items-center mt-6 px-4 py-2 text-teal font-medium hover:underline"
            >
              Add New Package &rarr;
            </a>
          </div>
        )
      }
    </div>
  </div>
</AdminLayout>
