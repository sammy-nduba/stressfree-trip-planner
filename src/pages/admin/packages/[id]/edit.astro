---
import AdminLayout from "../../../../layouts/AdminLayout.astro";
import { createServerSupabaseClient } from "../../../../lib/supabase";

const { id } = Astro.params;

// Create server-side Supabase client with authenticated session
const supabase = createServerSupabaseClient(Astro.cookies);

// Fetch existing package data
const { data: pkg, error: fetchError } = await supabase
    .from("packages")
    .select("*")
    .eq("id", id)
    .single();

if (fetchError || !pkg) {
    return Astro.redirect("/admin/packages");
}

// Handle form submission
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const title = formData.get("title");
        const description = formData.get("description");
        const price = formData.get("price");
        const duration = formData.get("duration");
        const destination_id = formData.get("destination_id");
        const custom_destination = formData.get("custom_destination");
        const imageFiles = formData.getAll("images") as File[];

        let imageUrls: string[] = [...(pkg.images || [])];

        // Process new images if any are uploaded
        const newImageUrls: string[] = [];
        for (const imageFile of imageFiles) {
            if (imageFile && imageFile.size > 0) {
                const fileExt = imageFile.name.split(".").pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;

                const { error: uploadError } = await supabase.storage
                    .from("packages")
                    .upload(fileName, imageFile);

                if (uploadError) {
                    console.error("Upload error:", uploadError);
                    throw uploadError;
                }

                const {
                    data: { publicUrl },
                } = supabase.storage.from("packages").getPublicUrl(fileName);

                newImageUrls.push(publicUrl);
            }
        }

        // If new images were uploaded, we might want to replace the old ones or append.
        // For this implementation, let's append if there are new ones,
        // or keep old ones if no new ones are uploaded.
        // If the user wants to completely replace, we should handle that.
        // To keep it simple: if new images are uploaded, use only new ones.
        if (newImageUrls.length > 0) {
            imageUrls = newImageUrls;
        }

        const inclusions = formData
            .get("included")
            ?.toString()
            .split("\n")
            .filter((i) => i.trim());
        const exclusions = formData
            .get("not_included")
            ?.toString()
            .split("\n")
            .filter((i) => i.trim());

        const is_featured = formData.get("is_featured") === "on";

        const it_days = formData.getAll("it_day[]");
        const it_titles = formData.getAll("it_title[]");
        const it_descs = formData.getAll("it_desc[]");

        const itinerary: Record<string, string> = {};
        it_days.forEach((day, index) => {
            if (day && it_descs[index]) {
                itinerary[day.toString()] = it_descs[index].toString();
            }
        });

        const { error } = await supabase
            .from("packages")
            .update({
                name: title,
                description,
                price: parseFloat(price?.toString() || "0"),
                duration: parseInt(duration?.toString() || "0"),
                destination_id: destination_id
                    ? parseInt(destination_id.toString())
                    : null,
                custom_destination: custom_destination?.toString() || null,
                images: imageUrls,
                image_url: imageUrls[0],
                inclusions,
                exclusions,
                is_featured: is_featured,
                itinerary: Object.keys(itinerary).length > 0 ? itinerary : null,
            })
            .eq("id", id);

        if (error) throw error;

        return Astro.redirect("/admin/packages");
    } catch (error) {
        console.error("Error updating package:", error);
    }
}

// Fetch countries for the dropdown
const { data: countries } = await supabase
    .from("countries")
    .select("id, name")
    .order("name");
---

<AdminLayout title={`Edit ${pkg.name}`}>
    <div class="max-w-3xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Edit Package</h1>
            <a
                href="/admin/packages"
                class="text-gray-600 hover:text-gray-800 font-medium"
            >
                Cancel
            </a>
        </div>

        <form
            method="POST"
            enctype="multipart/form-data"
            class="bg-white rounded-xl shadow-lg p-8 space-y-6"
        >
            <!-- Basic Info -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label
                        for="title"
                        class="block text-sm font-medium text-gray-700"
                        >Package Title</label
                    >
                    <input
                        type="text"
                        id="title"
                        name="title"
                        required
                        value={pkg.name}
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="e.g., Magical Maldives"
                    />
                </div>

                <div class="space-y-2">
                    <label
                        for="country_id"
                        class="block text-sm font-medium text-gray-700"
                        >Country (Optional)</label
                    >
                    <select
                        id="country_id"
                        name="country_id"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                    >
                        <option value="">Select a country...</option>
                        {
                            countries?.map((country: any) => (
                                <option
                                    value={country.id}
                                    selected={pkg.country_id === country.id}
                                >
                                    {country.name}
                                </option>
                            ))
                        }
                    </select>
                </div>

                <div class="space-y-2">
                    <label
                        for="custom_destination"
                        class="block text-sm font-medium text-gray-700"
                        >Destination</label
                    >
                    <input
                        type="text"
                        id="custom_destination"
                        name="custom_destination"
                        required
                        value={pkg.custom_destination || ""}
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="e.g., Paris, France or Custom Location"
                    />
                    <p class="text-sm text-gray-500">
                        Type any destination name - you can create custom
                        locations beyond the predefined ones
                    </p>
                </div>
            </div>

            <div class="flex items-center gap-2 pb-4">
                <input
                    type="checkbox"
                    id="is_featured"
                    name="is_featured"
                    checked={pkg.is_featured}
                    class="w-4 h-4 text-teal border-gray-300 rounded focus:ring-teal"
                />
                <label
                    for="is_featured"
                    class="text-sm font-medium text-gray-700"
                    >Mark as Featured Package (shows on home page)</label
                >
            </div>

            <div class="space-y-2">
                <label
                    for="description"
                    class="block text-sm font-medium text-gray-700"
                    >Description</label
                >
                <textarea
                    id="description"
                    name="description"
                    rows="4"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                    placeholder="Detailed description of the package..."
                    >{pkg.description}</textarea
                >
            </div>

            <!-- Details -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label
                        for="price"
                        class="block text-sm font-medium text-gray-700"
                        >Price ($)</label
                    >
                    <input
                        type="number"
                        id="price"
                        name="price"
                        min="0"
                        step="0.01"
                        required
                        value={pkg.price}
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                    />
                </div>

                <div class="space-y-2">
                    <label
                        for="duration"
                        class="block text-sm font-medium text-gray-700"
                        >Duration (days)</label
                    >
                    <input
                        type="number"
                        id="duration"
                        name="duration"
                        min="1"
                        required
                        value={pkg.duration}
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="e.g., 5"
                    />
                </div>
            </div>

            <div class="space-y-2">
                <label
                    for="images"
                    class="block text-sm font-medium text-gray-700"
                    >Package Images (Leave empty to keep existing)</label
                >
                <input
                    type="file"
                    id="images"
                    name="images"
                    accept="image/*"
                    multiple
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                />
                <p class="text-sm text-gray-500">
                    Currently has {pkg.images?.length || 0} images. Uploading new
                    images will replace them.
                </p>
                {
                    pkg.images && pkg.images.length > 0 && (
                        <div class="flex gap-2 mt-2 overflow-x-auto p-2">
                            {pkg.images.map((img: string) => (
                                <img
                                    src={img}
                                    alt=""
                                    class="h-20 w-20 object-cover rounded shadow"
                                />
                            ))}
                        </div>
                    )
                }
            </div>

            <!-- Itinerary Section -->
            <div class="space-y-4 border-t border-gray-100 pt-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-800">
                        Package Itinerary
                    </h2>
                    <button
                        type="button"
                        id="add-day"
                        class="text-sm px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        + Add Day
                    </button>
                </div>

                <div id="itinerary-container" class="space-y-4">
                    {
                        pkg.itinerary ? (
                            Object.entries(pkg.itinerary).map(
                                ([day, activities]) => (
                                    <div class="itinerary-day bg-gray-50 p-4 rounded-xl relative group">
                                        <button
                                            type="button"
                                            class="remove-day absolute -right-2 -top-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            ×
                                        </button>
                                        <div class="grid md:grid-cols-6 gap-4">
                                            <div class="md:col-span-1">
                                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">
                                                    Day
                                                </label>
                                                <input
                                                    type="number"
                                                    name="it_day[]"
                                                    value={day}
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"
                                                />
                                            </div>
                                            <div class="md:col-span-2">
                                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">
                                                    Title (Optional)
                                                </label>
                                                <input
                                                    type="text"
                                                    name="it_title[]"
                                                    placeholder="e.g. Arrival"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"
                                                />
                                            </div>
                                            <div class="md:col-span-3">
                                                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">
                                                    Activities
                                                </label>
                                                <textarea
                                                    name="it_desc[]"
                                                    rows="2"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"
                                                >
                                                    {Array.isArray(activities)
                                                        ? activities.join("\n")
                                                        : activities}
                                                </textarea>
                                            </div>
                                        </div>
                                    </div>
                                ),
                            )
                        ) : (
                            <div class="itinerary-day bg-gray-50 p-4 rounded-xl relative group">
                                <div class="grid md:grid-cols-6 gap-4">
                                    <div class="md:col-span-1">
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">
                                            Day
                                        </label>
                                        <input
                                            type="number"
                                            name="it_day[]"
                                            value="1"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"
                                        />
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">
                                            Title (Optional)
                                        </label>
                                        <input
                                            type="text"
                                            name="it_title[]"
                                            placeholder="e.g. Arrival"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"
                                        />
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">
                                            Activities
                                        </label>
                                        <textarea
                                            name="it_desc[]"
                                            rows="2"
                                            placeholder="Describe what happens on this day..."
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"
                                        />
                                    </div>
                                </div>
                            </div>
                        )
                    }
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label
                        for="included"
                        class="block text-sm font-medium text-gray-700"
                        >Included (One per line)</label
                    >
                    <textarea
                        id="included"
                        name="included"
                        rows="6"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="Accommodation
Breakfast
Transfers"
                        >{pkg.inclusions?.join("\n")}</textarea
                    >
                </div>

                <div class="space-y-2">
                    <label
                        for="not_included"
                        class="block text-sm font-medium text-gray-700"
                        >Not Included (One per line)</label
                    >
                    <textarea
                        id="not_included"
                        name="not_included"
                        rows="6"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent"
                        placeholder="Flights
Visa
Personal Expenses"
                        >{pkg.exclusions?.join("\n")}</textarea
                    >
                </div>
            </div>

            <div class="pt-6 border-t border-gray-200 flex justify-end gap-4">
                <a
                    href="/admin/packages"
                    class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors"
                >
                    Cancel
                </a>
                <button
                    type="submit"
                    class="px-6 py-2 bg-teal text-white rounded-lg hover:bg-teal/90 font-medium transition-colors"
                >
                    Update Package
                </button>
            </div>
        </form>
    </div>
</AdminLayout>

<script>
    const container = document.getElementById("itinerary-container");
    const addButton = document.getElementById("add-day");

    // Handle initial removal buttons if any
    container?.querySelectorAll(".remove-day").forEach((btn) => {
        btn.addEventListener("click", () => {
            btn.closest(".itinerary-day")?.remove();
        });
    });

    addButton?.addEventListener("click", () => {
        const nextDay =
            (container?.querySelectorAll(".itinerary-day").length || 0) + 1;
        const dayHtml = `
            <div class="itinerary-day bg-gray-50 p-4 rounded-xl relative group">
                <button type="button" class="remove-day absolute -right-2 -top-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">×</button>
                <div class="grid md:grid-cols-6 gap-4">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Day</label>
                        <input type="number" name="it_day[]" value="${nextDay}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Title (Optional)</label>
                        <input type="text" name="it_title[]" placeholder="e.g. Activity Title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal" />
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Activities</label>
                        <textarea name="it_desc[]" rows="2" placeholder="Describe what happens on this day..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal"></textarea>
                    </div>
                </div>
            </div>
        `;

        const temp = document.createElement("div");
        temp.innerHTML = dayHtml.trim();
        const element = temp.firstChild;
        if (element && container) {
            container.appendChild(element);

            (element as HTMLElement)
                .querySelector(".remove-day")
                ?.addEventListener("click", () => {
                    (element as HTMLElement).remove();
                });
        }
    });
</script>
