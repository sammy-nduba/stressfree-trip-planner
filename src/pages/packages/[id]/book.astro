---
import Layout from "../../../layouts/Layout.astro";
import { createServerSupabaseClient } from "../../../lib/supabase";

// Create server-side Supabase client
const supabase = createServerSupabaseClient(Astro.cookies);

// Server-side auth check
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  const currentPath = Astro.url.pathname;
  return Astro.redirect(`/auth/login?redirect=${currentPath}`);
}

const { id } = Astro.params;

// Fetch package details
const { data: pkg, error } = await supabase
  .from("packages")
  .select("*")
  .eq("id", id)
  .single();

if (error || !pkg) {
  return Astro.redirect("/packages");
}
---

<Layout title={`Book ${pkg.title || pkg.name} - Stress-Free Holiday Makers`}>
  <section class="pt-24 pb-20 bg-gradient-to-b from-sky to-white min-h-screen">
    <div class="max-w-4xl mx-auto px-6">
      <!-- Header -->
      <div class="text-center mb-0 md:mb-8">
        <h1 class="text-4xl md:text-5xl font-serif text-ocean mb-4">
          Book Your Adventure
        </h1>
        <p class="text-ocean/70 text-lg">
          Complete your booking for <strong>{pkg.title || pkg.name}</strong> in {
            pkg.destination || pkg.custom_destination || "Selected Destination"
          }
        </p>
      </div>

      <!-- Package Summary -->
      <div class="bg-white rounded-3xl shadow-lg p-6 mb-8 mt-8">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-serif text-ocean mb-1">
              {pkg.title || pkg.name}
            </h2>
            <p class="text-ocean/70">
              {pkg.destination || pkg.custom_destination} • {
                pkg.duration_days || pkg.duration
              } days
            </p>
          </div>
          <div class="text-right">
            <div class="text-3xl font-bold text-teal">${pkg.price}</div>
            <div class="text-sm text-ocean/60">per person</div>
          </div>
        </div>

        {
          pkg.itinerary && (
            <div class="mt-6 pt-6 border-t border-gray-100">
              <details class="group">
                <summary class="flex items-center justify-between cursor-pointer text-teal font-medium group-open:mb-4">
                  <span>View Full Itinerary</span>
                  <span class="transform group-open:rotate-180 transition-transform">
                    ↓
                  </span>
                </summary>
                <div class="space-y-4 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                  {Object.entries(pkg.itinerary || {}).map(
                    ([day, activities]) => (
                      <div class="pl-4 border-l-2 border-teal/30">
                        <p class="font-bold text-ocean text-sm">Day {day}</p>
                        <p class="text-ocean/70 text-sm italic">
                          {Array.isArray(activities)
                            ? activities[0]
                            : activities}
                        </p>
                      </div>
                    ),
                  )}
                </div>
              </details>
            </div>
          )
        }
      </div>

      <!-- Booking Form -->
      <div class="bg-white rounded-3xl shadow-lg p-8">
        <form
          id="booking-form"
          class="space-y-6"
          data-package-id={pkg.id}
          data-package-price={pkg.price}
        >
          <!-- Travel Dates -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-ocean font-medium mb-2">
                Start Date <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="start-date"
                name="startDate"
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-teal"
                required
              />
            </div>
            <div>
              <label class="block text-ocean font-medium mb-2">
                End Date <span class="text-red-500">*</span>
              </label>
              <input
                type="date"
                id="end-date"
                name="endDate"
                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-teal"
                required
              />
            </div>
          </div>

          <!-- Travelers -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-ocean font-medium mb-2">
                Number of Adults <span class="text-red-500">*</span>
              </label>
              <div class="flex items-center gap-4">
                <button
                  type="button"
                  id="adults-minus"
                  class="w-10 h-10 rounded-full bg-gray-100 text-ocean hover:bg-teal hover:text-white transition-colors font-bold"
                >
                  −
                </button>
                <input
                  type="number"
                  id="adults"
                  name="adults"
                  value="2"
                  min="1"
                  max="10"
                  class="w-16 text-center px-3 py-2 rounded-lg border border-gray-200"
                  readonly
                />
                <button
                  type="button"
                  id="adults-plus"
                  class="w-10 h-10 rounded-full bg-gray-100 text-ocean hover:bg-teal hover:text-white transition-colors font-bold"
                >
                  +
                </button>
              </div>
            </div>
            <div>
              <label class="block text-ocean font-medium mb-2">
                Number of Children
              </label>
              <div class="flex items-center gap-4">
                <button
                  type="button"
                  id="children-minus"
                  class="w-10 h-10 rounded-full bg-gray-100 text-ocean hover:bg-teal hover:text-white transition-colors font-bold"
                >
                  −
                </button>
                <input
                  type="number"
                  id="children"
                  name="children"
                  value="0"
                  min="0"
                  max="10"
                  class="w-16 text-center px-3 py-2 rounded-lg border border-gray-200"
                  readonly
                />
                <button
                  type="button"
                  id="children-plus"
                  class="w-10 h-10 rounded-full bg-gray-100 text-ocean hover:bg-teal hover:text-white transition-colors font-bold"
                >
                  +
                </button>
              </div>
            </div>
          </div>

          <!-- Special Requests -->
          <div>
            <label class="block text-ocean font-medium mb-2">
              Special Requests (Optional)
            </label>
            <textarea
              id="special-requests"
              name="specialRequests"
              rows="4"
              class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-teal"
              placeholder="Any special dietary requirements, accessibility needs, or other requests..."
            ></textarea>
          </div>

          <!-- Booking Summary -->
          <div id="booking-summary" class="bg-gray-50 rounded-2xl p-6">
            <h3 class="text-lg font-serif text-ocean mb-4">Booking Summary</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-ocean/70">Package:</span>
                <span class="font-medium">{pkg.title || pkg.name}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-ocean/70">Duration:</span>
                <span class="font-medium"
                  >{pkg.duration_days || pkg.duration} days</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-ocean/70">Travelers:</span>
                <span id="summary-travelers" class="font-medium"
                  >2 adults, 0 children</span
                >
              </div>
              <div class="flex justify-between">
                <span class="text-ocean/70">Price per person:</span>
                <span class="font-medium">${pkg.price}</span>
              </div>
              <hr class="border-gray-200" />
              <div class="flex justify-between text-xl font-bold">
                <span>Total Amount:</span>
                <span id="total-amount" class="text-teal">$0</span>
              </div>
            </div>
          </div>

          <!-- Terms and Conditions -->
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              id="terms"
              name="terms"
              class="mt-1 w-4 h-4 text-teal border-gray-300 rounded focus:ring-teal"
              required
            />
            <label for="terms" class="text-sm text-ocean/70">
              I agree to the <a href="/terms" class="text-teal hover:underline"
                >Terms and Conditions</a
              >
              and <a href="/privacy" class="text-teal hover:underline"
                >Privacy Policy</a
              >. I understand that this booking is subject to availability and
              confirmation.
            </label>
          </div>

          <!-- Error Messages -->
          <div
            id="error-message"
            class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"
          >
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-booking"
            class="w-full py-4 bg-teal text-white rounded-xl font-medium text-lg hover:bg-teal/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Proceed to Payment
          </button>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { supabase } from "../../../lib/supabase";

  // Get package data from dataset
  const bookingForm = document.getElementById(
    "booking-form",
  ) as HTMLFormElement | null;
  const packageId = bookingForm?.dataset.packageId;
  const packagePrice = parseFloat(bookingForm?.dataset.packagePrice || "0");

  // Form elements
  const startDateInput = document.getElementById(
    "start-date",
  ) as HTMLInputElement | null;
  const endDateInput = document.getElementById(
    "end-date",
  ) as HTMLInputElement | null;
  const adultsInput = document.getElementById(
    "adults",
  ) as HTMLInputElement | null;
  const childrenInput = document.getElementById(
    "children",
  ) as HTMLInputElement | null;
  const adultsMinus = document.getElementById("adults-minus");
  const adultsPlus = document.getElementById("adults-plus");
  const childrenMinus = document.getElementById("children-minus");
  const childrenPlus = document.getElementById("children-plus");
  const summaryTravelers = document.getElementById("summary-travelers");
  const totalAmount = document.getElementById("total-amount");
  const submitButton = document.getElementById(
    "submit-booking",
  ) as HTMLButtonElement | null;
  const errorMessage = document.getElementById("error-message");

  // Set minimum date to today
  const today = new Date().toISOString().split("T")[0];
  if (startDateInput) startDateInput.min = today;
  if (endDateInput) endDateInput.min = today;

  // Handle date changes
  startDateInput?.addEventListener("change", (e) => {
    if (endDateInput) endDateInput.min = (e.target as HTMLInputElement).value;
    updateSummary();
  });

  endDateInput?.addEventListener("change", () => {
    updateSummary();
  });

  // Handle traveler count changes
  adultsMinus?.addEventListener("click", () => {
    const current = parseInt(adultsInput?.value || "0");
    if (current > 1 && adultsInput) {
      adultsInput.value = (current - 1).toString();
      updateSummary();
    }
  });

  adultsPlus?.addEventListener("click", () => {
    const current = parseInt(adultsInput?.value || "0");
    if (current < 10 && adultsInput) {
      adultsInput.value = (current + 1).toString();
      updateSummary();
    }
  });

  childrenMinus?.addEventListener("click", () => {
    const current = parseInt(childrenInput?.value || "0");
    if (current > 0 && childrenInput) {
      childrenInput.value = (current - 1).toString();
      updateSummary();
    }
  });

  childrenPlus?.addEventListener("click", () => {
    const current = parseInt(childrenInput?.value || "0");
    if (current < 10 && childrenInput) {
      childrenInput.value = (current + 1).toString();
      updateSummary();
    }
  });

  // Update booking summary
  function updateSummary() {
    const adults = parseInt(adultsInput?.value || "0");
    const children = parseInt(childrenInput?.value || "0");
    const totalTravelers = adults + children;
    const totalPrice = totalTravelers * packagePrice;

    if (summaryTravelers)
      summaryTravelers.textContent = `${adults} adult${adults !== 1 ? "s" : ""}, ${children} child${children !== 1 ? "ren" : ""}`;
    if (totalAmount) totalAmount.textContent = `$${totalPrice}`;
  }

  // Initialize summary
  updateSummary();

  // Handle form submission
  bookingForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = "Creating Booking...";
    }
    errorMessage?.classList.add("hidden");

    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user) throw new Error("User not authenticated");

      const formData = new FormData(bookingForm);
      const bookingData = {
        user_id: user.id,
        package_id: packageId,
        travel_dates: {
          start_date: formData.get("startDate"),
          end_date: formData.get("endDate"),
        },
        participants: {
          adults: parseInt(formData.get("adults") as string),
          children: parseInt(formData.get("children") as string),
        },
        special_requests: formData.get("specialRequests"),
        total_price: calculateTotalPrice(),
        status: "pending",
      };

      // Create booking in database
      const { data: booking, error } = await supabase
        .from("bookings")
        .insert([bookingData])
        .select()
        .single();

      if (error) throw error;

      // Redirect to payment page
      window.location.href = `/packages/book/${booking.id}/payment`;
    } catch (error: any) {
      console.error("Error creating booking:", error);
      if (errorMessage) {
        errorMessage.textContent =
          error.message || "Failed to create booking. Please try again.";
        errorMessage.classList.remove("hidden");
      }
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = "Proceed to Payment";
      }
    }
  });

  function calculateTotalPrice() {
    const adults = parseInt(adultsInput?.value || "0");
    const children = parseInt(childrenInput?.value || "0");
    return (adults + children) * packagePrice;
  }
</script>
